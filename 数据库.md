# 数据库结构文档

## 数据库信息

- **类型**: MongoDB
- **端口**: 27017
- **数据库名**: podcast

---

## 数据表集合

### 1. feeds (订阅源)

RSS播客订阅源表

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | ObjectId | 主键 |
| `rss_url` | String | RSS订阅地址 (唯一索引) |
| `title` | String | 播客标题 |
| `website` | String | 官网地址 |
| `image` | String | 封面图片URL |
| `description` | String | 描述 |
| `author` | String | 作者 |
| `language` | String | 语言 |
| `status` | String | 状态: active/paused/error |
| `last_checked` | DateTime | 最后检查时间 |
| `last_updated` | DateTime | 最后更新时间 |
| `check_error` | String | 检查错误信息 |
| `is_starred` | Boolean | 是否标星 |
| `is_favorite` | Boolean | 是否收藏 |
| `note` | String | 备注笔记 |
| `tags` | Array[String] | 标签 |
| `episode_count` | Integer | 节目数量 |
| `unread_count` | Integer | 未读数量 |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 更新时间 |

**索引**:
- `rss_url` (唯一)
- `status`
- `is_starred`
- `created_at`

---

### 2. episodes (单集)

播客节目单集表

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | ObjectId | 主键 |
| `feed_id` | ObjectId | 所属订阅源ID |
| `guid` | String | RSS中的唯一标识 |
| `title` | String | 节目标题 |
| `summary` | String | 节目摘要 |
| `content` | String | 完整内容 |
| `link` | String | 原文链接 |
| `published` | DateTime | 发布时间 |
| `audio_url` | String | 音频URL |
| `audio_type` | String | 音频类型 (如 audio/mpeg) |
| `audio_size` | Integer | 音频大小 (字节) |
| `duration` | Integer | 音频时长 (秒) |
| `image` | String | 封面图片URL |
| `chapters_url` | String | 章节数据URL |
| `transcript_url` | String | 官方字幕URL |
| `status` | String | 状态: new/downloading/downloaded/transcribing/transcribed/summarizing/summarized/error |
| `local_path` | String | 本地音频文件路径 |
| `is_read` | Boolean | 是否已读 |
| `is_starred` | Boolean | 是否标星 |
| `is_favorite` | Boolean | 是否收藏 |
| `play_position` | Integer | 播放位置 (秒) |
| `has_transcript` | Boolean | 是否有转录 |
| `has_summary` | Boolean | 是否有摘要 |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 更新时间 |

**状态流转**:
```
new -> downloading -> downloaded -> transcribing -> transcribed -> summarizing -> summarized
```

**索引**:
- `feed_id`
- `guid`
- `(feed_id, guid)` (唯一)
- `status`
- `is_starred`
- `published`

---

### 3. transcripts (转录)

节目转录文本表

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | ObjectId | 主键 |
| `episode_id` | ObjectId | 关联单集ID (唯一索引) |
| `text` | String | 完整转录文本 |
| `segments` | Array[Object] | 分段转录数据 |
| `segments[].start` | Number | 开始时间 (秒) |
| `segments[].end` | Number | 结束时间 (秒) |
| `segments[].speaker` | String | 说话人 (A/B/C/D) |
| `segments[].text` | String | 文本内容 |
| `segments[].time` | String | 时间显示 |
| `chapters` | Array[Object] | 章节数据 |
| `entities` | Array[Object] | 实体识别数据 |
| `speakers` | Array[String] | 说话人列表 |
| `language` | String | 语言 |
| `duration` | Number | 音频时长 |
| `source` | String | 来源: assemblyai/official/external |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 更新时间 |

**索引**:
- `episode_id` (唯一)

---

### 4. summaries (摘要)

AI生成的节目摘要表

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | ObjectId | 主键 |
| `episode_id` | ObjectId | 关联单集ID (唯一索引) |
| `summary_type` | String | 摘要类型: general/investment |
| `version` | String | 版本号 (v2) |
| `tldr` | String | 一句话总结 |
| `tags` | Array[String] | 标签 |
| `content` | Object | 完整内容 (类型特定) |
| `content.investment_signals` | Array | 投资信号 (investment类型) |
| `content.mentioned_tickers` | Array[String] | 提及的股票代码 |
| `content.market_insights` | Array | 市场洞察 |
| `content.key_quotes` | Array | 关键引用 |
| `content.risk_alerts` | Array | 风险提示 |
| `content.investment_thesis` | String | 投资论点 |
| `content.key_points` | Array | 核心要点 (general类型) |
| `content.why_it_matters` | String | 重要性 (general类型) |
| `content_zh` | Object | 中文翻译内容 |
| `model` | String | 使用的模型 |
| `tokens_used` | Object | Token使用统计 |
| `generation_time_seconds` | Number | 生成耗时 |
| `translated_at` | DateTime | 翻译时间 |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 更新时间 |

**索引**:
- `episode_id` (唯一)

---

### 5. tasks (异步任务)

后台异步任务表

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | ObjectId | 主键 |
| `task_id` | String | 任务ID (UUID, 唯一索引) |
| `task_type` | String | 任务类型: download/transcribe/summarize/refresh/translate |
| `episode_id` | String | 关联单集ID |
| `feed_id` | String | 关联订阅源ID |
| `status` | String | 状态: pending/processing/completed/failed |
| `progress` | Integer | 进度 (0-100) |
| `result` | Object | 任务结果 |
| `error_message` | String | 错误信息 |
| `created_at` | DateTime | 创建时间 |
| `started_at` | DateTime | 开始时间 |
| `completed_at` | DateTime | 完成时间 |

**索引**:
- `task_id` (唯一)
- `status`
- `created_at`

---

## 数据库索引总览

```javascript
// feeds
db.feeds.createIndex({ rss_url: 1 }, { unique: true })
db.feeds.createIndex({ status: 1 })
db.feeds.createIndex({ is_starred: 1 })
db.feeds.createIndex({ created_at: 1 })

// episodes
db.episodes.createIndex({ feed_id: 1 })
db.episodes.createIndex({ guid: 1 })
db.episodes.createIndex({ feed_id: 1, guid: 1 }, { unique: true })
db.episodes.createIndex({ status: 1 })
db.episodes.createIndex({ is_starred: 1 })
db.episodes.createIndex({ published: -1 })

// transcripts
db.transcripts.createIndex({ episode_id: 1 }, { unique: true })

// summaries
db.summaries.createIndex({ episode_id: 1 }, { unique: true })

// tasks
db.tasks.createIndex({ task_id: 1 }, { unique: true })
db.tasks.createIndex({ status: 1 })
db.tasks.createIndex({ created_at: -1 })
```
